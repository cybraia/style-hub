<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Try-On - E-commerce Catalog</title>
    <!-- Set your Google Gemini API key here -->
    <script>
        // Get API key from environment or prompt user
        window.GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || 
                                prompt('Please enter your Google Gemini API key:\n\nYou can get one from: https://ai.google.dev') ||
                                '';
        
        if (window.GEMINI_API_KEY) {
            localStorage.setItem('gemini_api_key', window.GEMINI_API_KEY);
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 6px;
            transition: background-color 0.3s;
            margin-bottom: 20px;
        }

        .back-link:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Upload Section */
        .upload-section {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .upload-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .upload-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .upload-container {
                grid-template-columns: 1fr;
            }
        }

        .upload-box {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f8f9ff;
        }

        .upload-box:hover {
            background-color: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-box input {
            display: none;
        }

        .upload-box label {
            cursor: pointer;
            display: block;
        }

        .upload-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .upload-box p {
            color: #666;
            font-size: 0.9em;
        }

        .upload-box.uploaded {
            background-color: #e8f5e9;
            border-color: #4caf50;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .image-preview.show {
            display: block;
        }

        .upload-label-text {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .controls {
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background-color: #667eea;
            color: white;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary:hover {
            background-color: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
            width: 100%;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        /* Result Section */
        .result-section {
            background-color: #1a1f3a;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-content {
            width: 100%;
            text-align: center;
        }

        .loading {
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px dashed #667eea;
            border-radius: 50%;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #ccc;
            font-size: 1.1em;
            font-weight: 500;
        }

        .placeholder {
            color: #999;
        }

        .placeholder p {
            margin-bottom: 10px;
        }

        .result-image {
            display: none;
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .result-image.show {
            display: block;
        }

        .result-title {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            display: none;
        }

        .result-title.show {
            display: block;
        }

        /* Info Box */
        .info-box {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .feature-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        @media (max-width: 600px) {
            .feature-list {
                grid-template-columns: 1fr;
            }
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .feature-icon {
            color: #667eea;
            font-weight: bold;
            margin-top: 2px;
        }

        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .error-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Catalog</a>
        
        <div class="header">
            <h1>üëó Virtual Try-On Studio</h1>
            <p style="color: rgba(255, 255, 255, 0.9);">Upload your photo and see how clothes look on you with AI magic</p>
        </div>

        <div class="main-grid">
            <!-- Upload Section -->
            <div class="upload-section">
                <h2>üì∏ Your Images</h2>
                
                <div class="upload-container">
                    <!-- Person Image Upload -->
                    <div class="upload-box" id="personUploadBox">
                        <label for="personImageInput">
                            <div class="upload-icon">üë§</div>
                            <div class="upload-label-text">Your Photo</div>
                            <p>Upload a photo of yourself</p>
                        </label>
                        <input type="file" id="personImageInput" accept="image/*">
                        <img class="image-preview" id="personPreview" alt="Person preview">
                    </div>

                    <!-- Clothing Image Upload -->
                    <div class="upload-box" id="clothingUploadBox">
                        <label for="clothingImageInput">
                            <div class="upload-icon">üëï</div>
                            <div class="upload-label-text">Clothing Item</div>
                            <p>Upload the clothing you want to try</p>
                        </label>
                        <input type="file" id="clothingImageInput" accept="image/*">
                        <img class="image-preview" id="clothingPreview" alt="Clothing preview">
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" id="tryItOnBtn" disabled>
                        ‚ú® Try It On
                    </button>
                    <button class="btn btn-secondary" id="resetBtn">
                        Clear Images
                    </button>
                </div>

                <div class="error-message" id="errorMessage"></div>
            </div>

            <!-- Result Section -->
            <div class="result-section">
                <div class="result-content">
                    <div class="loading" id="loadingContainer">
                        <div class="spinner"></div>
                        <p class="loading-text" id="loadingText">Warming up the virtual dressing room...</p>
                    </div>

                    <div class="placeholder" id="placeholderContent">
                        <p style="font-size: 2em; margin-bottom: 10px;">‚ú®</p>
                        <p style="color: #ccc; font-size: 1.1em; font-weight: 500;">Your generated image will appear here</p>
                        <p style="color: #999; margin-top: 10px;">Upload your images and click "Try It On" to begin</p>
                    </div>

                    <div id="resultContainer">
                        <h2 class="result-title" id="resultTitle">Your Virtual Try-On</h2>
                        <img class="result-image" id="resultImage" alt="Generated virtual try-on">
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="info-box">
            <h3>‚ÑπÔ∏è How Virtual Try-On Works</h3>
            <p>Our AI-powered virtual try-on technology uses advanced computer vision to:</p>
            <div class="feature-list">
                <div class="feature-item">
                    <span class="feature-icon">‚úì</span>
                    <span>Detect your body shape and posture</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">‚úì</span>
                    <span>Analyze clothing fit and style</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">‚úì</span>
                    <span>Generate photorealistic results</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">‚úì</span>
                    <span>Process in just a few seconds</span>
                </div>
            </div>
            <p style="margin-top: 15px; color: #999; font-size: 0.9em;">üí° Tip: For best results, wear fitting clothes and face the camera directly.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@google/genai@0.1.0/dist/index.min.js"></script>
    <script>
        // Loading messages
        const loadingMessages = [
            "Warming up the virtual dressing room...",
            "Tailoring the fit with AI precision...",
            "Generating a photorealistic look...",
            "Adding the final touches...",
            "Almost ready for the runway!",
        ];

        // DOM Elements
        const personImageInput = document.getElementById('personImageInput');
        const clothingImageInput = document.getElementById('clothingImageInput');
        const personPreview = document.getElementById('personPreview');
        const clothingPreview = document.getElementById('clothingPreview');
        const personUploadBox = document.getElementById('personUploadBox');
        const clothingUploadBox = document.getElementById('clothingUploadBox');
        const tryItOnBtn = document.getElementById('tryItOnBtn');
        const resetBtn = document.getElementById('resetBtn');
        const loadingContainer = document.getElementById('loadingContainer');
        const loadingText = document.getElementById('loadingText');
        const resultImage = document.getElementById('resultImage');
        const resultTitle = document.getElementById('resultTitle');
        const resultContainer = document.getElementById('resultContainer');
        const placeholderContent = document.getElementById('placeholderContent');
        const errorMessage = document.getElementById('errorMessage');

        let currentMessageIndex = 0;
        let loadingInterval = null;

        // Convert file to base64
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // Generate virtual try-on image using Google Gemini API
        const generateVirtualTryOnImage = async (personImage, clothingImage) => {
            const apiKey = window.GEMINI_API_KEY;
            
            if (!apiKey) {
                throw new Error("Google Gemini API key is not configured. Please set it in your environment.");
            }

            const { GoogleGenAI, Modality } = window;
            const ai = new GoogleGenAI({ apiKey });

            const personImageBase64 = await fileToBase64(personImage);
            const clothingImageBase64 = await fileToBase64(clothingImage);

            const prompt = `
    You are a virtual try-on expert.
    Your task is to take the person from the first image and the clothing item from the second image and generate a new, photorealistic image where the person is wearing the clothing.
    Preserve the person's original pose, face, hair, and the background from the first image as much as possible.
    Only replace the clothing on the person with the clothing from the second image.
    Pay close attention to the style of the clothing. For example, if the clothing item is sleeveless, the generated image should show the person's arms.
    The final image should be realistic and high quality.
  `;

            const personImagePart = {
                inlineData: {
                    data: personImageBase64,
                    mimeType: personImage.type || 'image/jpeg',
                },
            };

            const clothingImagePart = {
                inlineData: {
                    data: clothingImageBase64,
                    mimeType: clothingImage.type || 'image/jpeg',
                },
            };

            const textPart = {
                text: prompt,
            };

            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash-image',
                    contents: {
                        parts: [
                            personImagePart,
                            clothingImagePart,
                            textPart,
                        ],
                    },
                    config: {
                        responseModalities: [Modality.IMAGE],
                    },
                });

                for (const part of response.candidates?.[0]?.content?.parts || []) {
                    if (part.inlineData) {
                        const base64ImageBytes = part.inlineData.data;
                        const mimeType = part.inlineData.mimeType;
                        return `data:${mimeType};base64,${base64ImageBytes}`;
                    }
                }

                throw new Error('No image was generated by the model.');
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw new Error("Failed to generate image. The model may have refused the request due to safety policies or other issues.");
            }
        };

        // File input handlers
        personImageInput.addEventListener('change', (e) => {
            handleImageUpload(e, personPreview, personUploadBox);
            updateTryOnButton();
        });

        clothingImageInput.addEventListener('change', (e) => {
            handleImageUpload(e, clothingPreview, clothingUploadBox);
            updateTryOnButton();
        });

        function handleImageUpload(event, previewElement, uploadBox) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewElement.src = e.target.result;
                    previewElement.classList.add('show');
                    uploadBox.classList.add('uploaded');
                };
                reader.readAsDataURL(file);
            }
        }

        function updateTryOnButton() {
            const hasPerson = personImageInput.files.length > 0;
            const hasClothing = clothingImageInput.files.length > 0;
            tryItOnBtn.disabled = !(hasPerson && hasClothing);
        }

        // Reset button
        resetBtn.addEventListener('click', () => {
            personImageInput.value = '';
            clothingImageInput.value = '';
            personPreview.classList.remove('show');
            clothingPreview.classList.remove('show');
            personUploadBox.classList.remove('uploaded');
            clothingUploadBox.classList.remove('uploaded');
            resultImage.classList.remove('show');
            resultTitle.classList.remove('show');
            placeholderContent.classList.remove('hide');
            loadingContainer.classList.remove('show');
            errorMessage.classList.remove('show');
            updateTryOnButton();
        });

        // Try It On button
        tryItOnBtn.addEventListener('click', async () => {
            await startVirtualTryOn();
        });

        async function startVirtualTryOn() {
            const personFile = personImageInput.files[0];
            const clothingFile = clothingImageInput.files[0];

            if (!personFile || !clothingFile) {
                showError('Please upload both images');
                return;
            }

            // Show loading state
            showLoading();

            try {
                // Call the Google Gemini API directly
                const resultImageUrl = await generateVirtualTryOnImage(personFile, clothingFile);

                // Display the result
                displayResult(resultImageUrl);

            } catch (error) {
                console.error('Virtual Try-On Error:', error);
                showError(error.message || 'Failed to generate virtual try-on. Please try again.');
            } finally {
                stopLoading();
            }
        }

        function showLoading() {
            placeholderContent.style.display = 'none';
            resultImage.classList.remove('show');
            resultTitle.classList.remove('show');
            loadingContainer.classList.add('show');
            errorMessage.classList.remove('show');

            currentMessageIndex = 0;
            loadingText.textContent = loadingMessages[0];

            loadingInterval = setInterval(() => {
                currentMessageIndex = (currentMessageIndex + 1) % loadingMessages.length;
                loadingText.textContent = loadingMessages[currentMessageIndex];
            }, 2500);
        }

        function stopLoading() {
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
            loadingContainer.classList.remove('show');
        }

        function displayResult(imageUrl) {
            resultImage.src = imageUrl;
            resultImage.classList.add('show');
            resultTitle.classList.add('show');
            placeholderContent.style.display = 'none';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
        }

        // Initialize button state
        updateTryOnButton();
    </script>
</body>
</html>
